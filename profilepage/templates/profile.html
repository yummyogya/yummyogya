{% extends 'base.html' %}

{% block content %}
{% include 'navbar.html' %}

<style>
    footer {
        background-color: #FF6600;
        color: white;
        text-align: center;
        padding: 10px;
        margin-top: 20px;
    }
</style>
<div style="max-width: 700px; margin: 40px auto 196px auto; padding-top: 100px;">

    <!-- Informasi Pengguna -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
        <div class="flex items-center space-x-4">
            {% if user.profile.profile_photo %}
                <img src="{{ user.profile.profile_photo.url }}" alt="Foto Profil" class="w-16 h-16 rounded-full">
            {% else %}
                <div class="w-16 h-16 rounded-full bg-gray-200"></div>
            {% endif %}
            <div>
                <h2 class="text-2xl font-semibold">{{ user.username }}</h2>
                <p class="text-sm text-gray-600">Bergabung sejak: {{ user.date_joined|date:"d M Y" }}</p>
                <p class="text-sm text-gray-600">Terakhir login: {{ user.last_login|date:"d M Y, H:i" }}</p>
            </div>
        </div>
        <div class="mt-4">
            <p class="text-gray-800">{{ user.profile.bio }}</p>
        </div>
        <button class="mt-4 bg-orange-600 text-white px-4 py-2 rounded" id="edit-profile-btn">Edit Profile</button>
    </div>

    <!-- Form Edit Profile AJAX-->
    <div id="edit-profile-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded shadow-lg p-6 w-full max-w-3xl"> <!-- Adjusted the width here -->
            <h2 class="text-2xl mb-4">Edit Profile</h2>
            <!-- Error Handling Block -->
            {% if profile_form.errors or password_form.errors %}
                <ul class="text-red-500 mb-4">
                    {% for field, errors in profile_form.errors.items %}
                        <li>{{ field }}: {{ errors|join:", " }}</li>
                    {% endfor %}
                    {% for field, errors in password_form.errors.items %}
                        <li>{{ field }}: {{ errors|join:", " }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            
            <form id="edit-profile-form" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="profile_photo" class="block font-semibold mb-2">Foto Profil</label>
                    <input type="file" name="profile_photo" id="profile_photo" class="border border-gray-300 rounded px-4 py-2 w-full"> <!-- Added border and styling -->
                </div>
                <div class="mb-4">
                    <label for="bio" class="block font-semibold mb-2">Bio</label>
                    <textarea name="bio" id="bio" rows="3" class="border border-gray-300 rounded px-4 py-2 w-full"></textarea> <!-- Added border and styling -->
                </div>
                <div class="mb-4">
                    <label for="old_password" class="block font-semibold mb-2">Password Lama</label>
                    <input type="password" name="old_password" id="old_password" class="border border-gray-300 rounded px-4 py-2 w-full"> <!-- Added border and styling -->
                </div>
                <div class="mb-4">
                    <label for="new_password1" class="block font-semibold mb-2">Password Baru</label>
                    <input type="password" name="new_password1" id="new_password1" class="border border-gray-300 rounded px-4 py-2 w-full"> <!-- Added border and styling -->
                </div>
                <div class="mb-4">
                    <label for="new_password2" class="block font-semibold mb-2">Konfirmasi Password Baru</label>
                    <input type="password" name="new_password2" id="new_password2" class="border border-gray-300 rounded px-4 py-2 w-full"> <!-- Added border and styling -->
                </div>
                <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded">Simpan Perubahan</button>
                <button type="button" id="close-modal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded">Batal</button>
            </form>
        </div>
    </div>

    <!-- Wishlist -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
        <h3 class="text-xl font-semibold mb-4">Wishlist</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            {% for item in wishlist_items %}
                <div class="bg-gray-100 p-4 rounded-lg text-center">
                    <p class="font-semibold">{{ item.food.name }}</p>
                </div>
            {% endfor %}
        </div>
        <a href="{% url 'wishlist:view_wishlist' %}" class="mt-4 inline-block text-orange-600 font-semibold">Lihat seluruh wishlist</a>
    </div>

    <!-- Riwayat Ulasan -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
        <h3 class="text-xl font-semibold mb-4">Riwayat Ulasan</h3>
        {% if reviews %}
            <ul>
                {% for review in reviews %}
                    <li class="mb-4">
                        <a href="{% url 'detail_makanan:food_detail' review.food.id %}" class="text-orange-600 font-semibold">{{ review.food.name }}</a>
                        <p class="text-sm text-gray-600">Rating: {{ review.rating }}/5</p>
                        <p class="text-gray-800">{{ review.review }}</p>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-gray-600">Belum ada ulasan.</p>
        {% endif %}
    </div>
</div>

<footer>
    <p>&copy; 2024 Yummyogya. Semua hak dilindungi undang-undang.</p>
</footer>

<!-- JavaScript for toggling edit form -->
<script>
    document.getElementById('edit-profile-btn').addEventListener('click', function() {
        document.getElementById('edit-profile-modal').classList.remove('hidden');
    });
    
    document.getElementById('close-modal').addEventListener('click', function() {
        document.getElementById('edit-profile-modal').classList.add('hidden');
    });
    
    document.getElementById('edit-profile-form').addEventListener('submit', function(event) {
        event.preventDefault();
        let formData = new FormData(this);
        fetch("{% url 'profilepage:show_profile' %}", {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();  // Refresh page on success
            } else {
                console.error(data.errors);  // Display errors if needed
            }
        });
    });
    </script>

{% endblock content %}
